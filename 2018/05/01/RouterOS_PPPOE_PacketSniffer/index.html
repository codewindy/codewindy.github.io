<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>RouterOS抓包恢复PPPOE密码 | codewindy</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="life," />
  

  <meta name="description" content="RouterOS PPPOE(Session) Password Packet Sniffer 背景 老家的破旧路由器跟不上现在的需求,想升级成更好的,但是宽带密码忘了,管理员密码也不记得了,如何恢复PPPOE密码?">
<meta property="og:type" content="article">
<meta property="og:title" content="RouterOS抓包恢复PPPOE密码">
<meta property="og:url" content="https://codewindy.github.io/2018/05/01/RouterOS_PPPOE_PacketSniffer/index.html">
<meta property="og:site_name" content="codewindy">
<meta property="og:description" content="RouterOS PPPOE(Session) Password Packet Sniffer 背景 老家的破旧路由器跟不上现在的需求,想升级成更好的,但是宽带密码忘了,管理员密码也不记得了,如何恢复PPPOE密码?">
<meta property="og:locale">
<meta property="og:image" content="https://i.loli.net/2019/05/02/5ccaa3bb59313.png">
<meta property="og:image" content="https://i.loli.net/2019/05/02/5ccaa3bc747cc.png">
<meta property="og:image" content="https://i.loli.net/2019/05/02/5ccaa3be60e45.png">
<meta property="og:image" content="https://i.loli.net/2019/05/02/5ccaa3bd57277.png">
<meta property="og:image" content="https://i.loli.net/2019/05/02/5ccaa3be54129.png">
<meta property="og:image" content="https://i.loli.net/2019/05/02/5ccaa3becc873.png">
<meta property="og:image" content="https://i.loli.net/2019/05/02/5ccaa3ba5e19d.png">
<meta property="og:image" content="https://i.loli.net/2019/05/02/5cca8c8d6a894.jpg">
<meta property="og:image" content="https://i.loli.net/2020/04/05/tlpzI5nU2fwXQbu.png">
<meta property="og:image" content="https://i.loli.net/2019/05/02/5ccaa3bdac0fa.png">
<meta property="article:published_time" content="2018-05-01T06:10:44.000Z">
<meta property="article:modified_time" content="2024-09-04T07:41:59.843Z">
<meta property="article:author" content="codewindy">
<meta property="article:tag" content="life">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2019/05/02/5ccaa3bb59313.png">

  

  
    <link rel="icon" href="/images/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">


  

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38189205-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script async src="https://umami-chi-teal.vercel.app/fexo" data-website-id="10ef6804-f78a-474d-a8e8-d06f5c737608"></script>

    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">Home</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">Home</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#RouterOS-PPPOE-Session-Password-Packet-Sniffer"><span class="toc-text">RouterOS PPPOE(Session) Password Packet Sniffer </span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%9D%A1%E4%BB%B6"><span class="toc-text">准备条件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B"><span class="toc-text">过程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-text">结论</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a>
  </div>



<div class="content content-post CENTER">
   <article id="post-RouterOS_PPPOE_PacketSniffer" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">RouterOS抓包恢复PPPOE密码</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2018.05.01</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>codewindy</span>
        </span>
      

      


      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
    </div>
  </header>

  <div class="article-content">
    
      <h2 id="RouterOS-PPPOE-Session-Password-Packet-Sniffer"><a href="#RouterOS-PPPOE-Session-Password-Packet-Sniffer" class="headerlink" title="RouterOS PPPOE(Session) Password Packet Sniffer "></a>RouterOS PPPOE(Session) Password Packet Sniffer </h2><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><ul>
<li>老家的破旧路由器跟不上现在的需求,想升级成更好的,但是宽带密码忘了,管理员密码也不记得了,如何恢复<strong>PPPOE</strong>密码?<span id="more"></span>
<h1 id="准备条件"><a href="#准备条件" class="headerlink" title="准备条件"></a>准备条件</h1></li>
<li>安装了虚拟机<strong>VMware</strong>的电脑并导入<a target="_blank" rel="noopener" href="https://github.com/codewindy/soft-common/blob/master/MikroTik-RouterOS-6.44.2_crackzsoft.com.ova">routeros6.44.2</a>镜像或淘宝<strong>rb750gr3</strong>等</li>
<li>网线一根</li>
<li><a target="_blank" rel="noopener" href="https://rsload.net/soft/10943-vmware-workstation.html">VMWARE 虚拟机</a> 下载</li>
<li><a target="_blank" rel="noopener" href="https://2.na.dl.wireshark.org/win64/Wireshark-win64-3.0.1.exe">wireshark</a> 下载</li>
<li><a target="_blank" rel="noopener" href="https://mikrotik.com/download#">winbox </a> 客户端</li>
</ul>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><ul>
<li><p>考虑到我买的rb750gr3不具有通用性及经济实惠性,我后面都采用虚拟机来实现<br><img src="https://i.loli.net/2019/05/02/5ccaa3bb59313.png" alt="2019-05-02_153951_000.png"></p>
<p><img src="https://i.loli.net/2019/05/02/5ccaa3bc747cc.png" alt="2019-05-02_150656_001.png"></p>
<p><img src="https://i.loli.net/2019/05/02/5ccaa3be60e45.png" alt="2019-05-02_151738_002.png"></p>
<p><img src="https://i.loli.net/2019/05/02/5ccaa3bd57277.png" alt="2019-05-02_152312_003.png"></p>
</li>
<li><p>先将家里老旧路由器的  <font style="color:black; background:yellow"> WAN口 </font>  插上网线连接到电脑的 <strong>RJ45网口</strong> </p>
</li>
<li><p>打开虚拟机<strong>vmware</strong> 导入 <a target="_blank" rel="noopener" href="https://github.com/codewindy/soft-common/blob/master/MikroTik-RouterOS-6.44.2_crackzsoft.com.ova">routeros 镜像</a>, 桥接到<strong><code>物理网卡</code></strong></p>
</li>
<li><p>下载并打开<strong>winbox</strong>客户端,并通过<strong>winbox</strong> 来登录ros,默认帐号是 <strong>admin</strong> 密码是 <strong>空</strong></p>
<p><img src="https://i.loli.net/2019/05/02/5ccaa3be54129.png" alt="2019-05-02_152916_004.png"></p>
<p><img src="https://i.loli.net/2019/05/02/5ccaa3becc873.png" alt="2019-05-02_153222_005.png"></p>
<p><img src="https://i.loli.net/2019/05/02/5ccaa3ba5e19d.png" alt="2019-05-02_153852_007.png"></p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[admin@fsm] &gt; ip export </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">may/02/2019 15:45:48 by RouterOS 6.44.2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">software <span class="built_in">id</span> = ZJ3M-ESHW</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">/ip pool</span></span><br><span class="line">add name=pool1 ranges=10.16.0.2-10.16.0.254</span><br><span class="line">/ip address</span><br><span class="line">add address=192.168.199.22/24 comment=defconf interface=ether1 network=192.168.199.0</span><br><span class="line">add address=192.168.199.122/24 interface=ether1 network=192.168.199.0</span><br><span class="line">/ip cloud</span><br><span class="line">set update-time=no</span><br><span class="line">/ip dhcp-client</span><br><span class="line">add dhcp-options=hostname,clientid disabled=no interface=ether1</span><br><span class="line">/ip dns</span><br><span class="line">set allow-remote-requests=yes servers=192.168.199.1</span><br><span class="line">/ip firewall nat</span><br><span class="line">add action=masquerade chain=srcnat out-interface-list=WAN</span><br><span class="line">/ip route</span><br><span class="line">add disabled=yes distance=1 gateway=192.168.199.1</span><br><span class="line">[admin@fsm] &gt; ppp export </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">may/02/2019 15:45:52 by RouterOS 6.44.2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">software <span class="built_in">id</span> = ZJ3M-ESHW</span></span><br><span class="line"></span><br><span class="line">/ppp profile</span><br><span class="line">add dns-server=223.5.5.5 local-address=10.16.0.1 name=8M remote-address=pool1</span><br></pre></td></tr></table></figure>

<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><ul>
<li><strong>chap ** 认证过程是md5加密的,但是</strong>pap <strong>是明文认证方式,所以我们通过ros伪造</strong>pppoe**服务器来抓包获取</li>
<li><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_5384e78b0100fhno.html">PPP-PAP认证原理</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_5384e78b0100fhnr.html">PPP-CHAP认证原理</a><blockquote>
<p>PPP提供了两种可选的身份认证方法：口令验证协议PAP（Password Authentication Protocol，PAP）和质询握手协议（Challenge Handshake Authentication Protocol，CHAP）。如果双方协商达成一致，也可以不使用任何身份认证方法。　　CHAP认证比PAP认证更安全，因为CHAP不在线路上发送明文密码，而是发送经过摘要算法加工过的随机序列，也 被称为”挑战字符串”.如图所示。同时，身份认证可以随时进行，包括在双方正常通信过程中。因此，非法用户就算截获并成功破解了一次密码，此密码也将在 一段时间内失效<br><img src="https://i.loli.net/2019/05/02/5cca8c8d6a894.jpg" alt="chap认证过程">)) </p>
</blockquote>
</li>
</ul>
<ul>
<li><strong>使用Java代码来创建和解析出账号密码</strong><br><img src="https://i.loli.net/2020/04/05/tlpzI5nU2fwXQbu.png" alt="PPPoE processon"></li>
<li><a target="_blank" rel="noopener" href="https://github.com/codewindy/JavaTutorials">项目地址</a> <code>https://github.com/codewindy/JavaTutorials</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codewindy.mongodb.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.FileUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.CharsetUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ssh.JschUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.extra.ssh.Sftp;</span><br><span class="line"><span class="keyword">import</span> com.codewindy.mongodb.pojo.ApiResult;</span><br><span class="line"><span class="keyword">import</span> com.codewindy.mongodb.pojo.PppoeDetail;</span><br><span class="line"><span class="keyword">import</span> com.codewindy.mongodb.service.MikrotikService;</span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> me.legrange.mikrotik.ApiConnection;</span><br><span class="line"><span class="keyword">import</span> me.legrange.mikrotik.MikrotikApiException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> codewindy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> &lt;a href=&quot;https://wiki.mikrotik.com/wiki/Manual:RouterOS_features&quot;&gt;RouterOS_features&lt;/&gt;</span></span><br><span class="line"><span class="comment"> *       RouterOS is MikroTik&#x27;s stand-alone operating system based on linux v3.3.5 kernel.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-03-25 9:44 PM</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MikrotikServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MikrotikService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult <span class="title function_">login</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">        <span class="type">ApiConnection</span> <span class="variable">con</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// connect to router</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            con = initApiConnection(username, password);</span><br><span class="line">            <span class="comment">// log in to router</span></span><br><span class="line">            List&lt;Map&lt;String, String&gt;&gt; execute = con.execute(<span class="string">&quot;/ip/address/print&quot;</span>);</span><br><span class="line">            <span class="comment">// execute a command</span></span><br><span class="line">            con.close();</span><br><span class="line">            <span class="comment">// disconnect from router</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResult</span>(execute);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (MikrotikApiException e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录RouterOS失败 = &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResult</span>(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    /ip pool add name=pppoe_pool1 ranges=10.10.10.2-10.10.10.254</span></span><br><span class="line"><span class="comment">    /ppp profile add name=pppoe_profile local-address=10.10.10.1 remote-address=pppoe_pool1</span></span><br><span class="line"><span class="comment">    /interface pppoe-server server add authentication=pap service-name=PPPoE_Server interface=wan one-session-per-host=yes default-profile=pppoe_profile</span></span><br><span class="line"><span class="comment">    Mikrotik API 调用和直接winbox的不同，需要添加/ 转义</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult <span class="title function_">createPPPOEServer</span><span class="params">(String ipPoolRange)</span> &#123;</span><br><span class="line">        <span class="type">ApiConnection</span> <span class="variable">con</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// connect to router</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            con = initApiConnection(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="comment">// log in to router</span></span><br><span class="line">            con.execute(<span class="string">&quot;/ip/pool/print&quot;</span>);</span><br><span class="line">            con.execute(<span class="string">&quot;/ip/pool/add name=pool1 ranges=10.10.10.2-10.10.20.1&quot;</span>);</span><br><span class="line">            con.execute(<span class="string">&quot;/ppp/profile/add name=pppoe_10M remote-address=pool1&quot;</span>);</span><br><span class="line">            con.execute(<span class="string">&quot;/ppp/secret/add name=0327 password=0327Test service=pppoe profile=pppoe_10M&quot;</span>);</span><br><span class="line">            con.execute(<span class="string">&quot;/interface/pppoe-server/server/add authentication=pap service-name=PPPoE_Server interface=ether1 one-session-per-host=yes default-profile=pppoe_10M&quot;</span>);</span><br><span class="line">            con.execute(<span class="string">&quot;/interface/pppoe-server/server/enable numbers=0&quot;</span>);</span><br><span class="line">            <span class="comment">//开始执行抓包pppoe-session file-limit=10KiB  控制文件大小 内存好像没起作用</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">command4capFileName</span> <span class="operator">=</span> <span class="string">&quot;/tool/sniffer/set file-name=%s.cap filter-mac-protocol=pppoe file-limit=10KiB memory-limit=10KiB&quot;</span>;</span><br><span class="line">            con.execute(String.format(command4capFileName, DateUtil.today()));</span><br><span class="line">            log.info(<span class="string">&quot;开始执行抓包pppoe-session===&#123;&#125;&quot;</span>, String.format(command4capFileName, DateUtil.today()));</span><br><span class="line">            con.execute(<span class="string">&quot;/tool/sniffer/start mac-protocol=pppoe interface=ether1 direction=rx&quot;</span>);</span><br><span class="line">            List&lt;Map&lt;String, String&gt;&gt; resultMapList = con.execute(<span class="string">&quot;/file/print&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Map&lt;String, String&gt; fileMap : resultMapList) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((fileMap.get(<span class="string">&quot;type&quot;</span>).contains(<span class="string">&quot;.cap&quot;</span>) || fileMap.get(<span class="string">&quot;type&quot;</span>).contains(<span class="string">&quot;.pcap&quot;</span>))&amp;&amp; Integer.parseInt(fileMap.get(<span class="string">&quot;size&quot;</span>))&gt;<span class="number">1000</span>)&#123;</span><br><span class="line">                    <span class="comment">//创建pppoe服务器抓包时候控制文件size 一般大于2000B 就无法执行file print detail，即不能在terminal上解析报文了</span></span><br><span class="line">                    con.execute(<span class="string">&quot;/tool/sniffer/stop&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResult</span>(<span class="string">&quot;初始化pppoe服务器成功!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MikrotikApiException e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录RouterOS失败 = &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResult</span>(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiConnection <span class="title function_">initApiConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> MikrotikApiException &#123;</span><br><span class="line">        ApiConnection con;</span><br><span class="line">        con = ApiConnection.connect(<span class="string">&quot;192.168.2.2&quot;</span>);</span><br><span class="line">        con.setTimeout(<span class="number">5000</span>);</span><br><span class="line">        <span class="comment">// set command timeout to 5 seconds</span></span><br><span class="line">        con.login(username, password);</span><br><span class="line">        <span class="keyword">return</span> con;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析后的json中包含了\u0000 空格</span></span><br><span class="line"><span class="comment">     *  &#123;</span></span><br><span class="line"><span class="comment">     *         &quot;account&quot;: &quot;test4pppoe&quot;,</span></span><br><span class="line"><span class="comment">     *         &quot;password&quot;: &quot;123456Test\u0000\u0000\u0000\u0000\u0000\u0000&quot;</span></span><br><span class="line"><span class="comment">     *     &#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult <span class="title function_">getPcapFileDetail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApiConnection</span> <span class="variable">con</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// connect to router</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            con = initApiConnection(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="comment">// log in to router</span></span><br><span class="line">            List&lt;Map&lt;String, String&gt;&gt; resultMapList = con.execute(<span class="string">&quot;/file/print&quot;</span>);</span><br><span class="line">            resultMapList.stream().filter(s -&gt; s.get(<span class="string">&quot;type&quot;</span>).contains(<span class="string">&quot;.cap&quot;</span>) || s.get(<span class="string">&quot;type&quot;</span>).contains(<span class="string">&quot;.pcap&quot;</span>)).forEach(s -&gt; System.out.println(<span class="string">&quot;pcap报文的size=&quot;</span>+s.get(<span class="string">&quot;size&quot;</span>)));</span><br><span class="line">            <span class="comment">//获取每个cap数据包里面的content</span></span><br><span class="line">            List&lt;String&gt; contentList = resultMapList.stream().filter(s -&gt; s.get(<span class="string">&quot;type&quot;</span>).contains(<span class="string">&quot;.cap&quot;</span>) || s.get(<span class="string">&quot;type&quot;</span>).contains(<span class="string">&quot;.pcap&quot;</span>)).map(s -&gt; s.get(<span class="string">&quot;contents&quot;</span>)).collect(Collectors.toList());</span><br><span class="line">            <span class="comment">//获取每个content里面的pppoe 账号密码</span></span><br><span class="line">            Set&lt;String&gt; pppoeAccountSet = contentList.stream().filter(content -&gt; content.contains(<span class="string">&quot;user&quot;</span>)&amp;&amp; content.contains(<span class="string">&quot;authentication&quot;</span>)).map(content -&gt; StrUtil.subBetween(content, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;authentication&quot;</span>).trim()).collect(Collectors.toSet());</span><br><span class="line">            List&lt;PppoeDetail&gt; pppoeDetailList = Lists.newArrayListWithCapacity(pppoeAccountSet.size());</span><br><span class="line">            <span class="keyword">for</span> (String pppoeAccount : pppoeAccountSet) &#123;</span><br><span class="line">                List&lt;String&gt; passwordlist = contentList.stream().filter(content-&gt;content.contains(pppoeAccount)).map(content -&gt; StrUtil.subBetween(content, pppoeAccount, <span class="string">&quot;\u0000&quot;</span>).trim()).distinct().collect(Collectors.toList());</span><br><span class="line">                <span class="type">PppoeDetail</span> <span class="variable">pppoeDetail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PppoeDetail</span>();</span><br><span class="line">                pppoeDetail.setAccount(pppoeAccount);</span><br><span class="line">                <span class="keyword">if</span> (!CollectionUtils.isEmpty(passwordlist)) &#123;</span><br><span class="line">                    <span class="comment">//直接截取字符串 去除了二进制流中的乱码 \u0000空格 �LV</span></span><br><span class="line">                    pppoeDetail.setPassword(StrUtil.subPre(passwordlist.get(<span class="number">0</span>),<span class="number">16</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                pppoeDetailList.add(pppoeDetail);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// execute a command</span></span><br><span class="line">            con.close();</span><br><span class="line">            <span class="comment">// disconnect from router</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResult</span>(pppoeDetailList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MikrotikApiException e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;获取PPPOESession详情失败 = &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResult</span>(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult <span class="title function_">downloadPPPOESession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//下载Packet Sniffer下载创建的pcap文件</span></span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">        <span class="comment">//1. 不能直接抓去pppoe-session的数据</span></span><br><span class="line">        <span class="comment">//2. pppoe 服务器的ip 地址动态传入</span></span><br><span class="line">        <span class="comment">//3. 切换网络会出现winbox退出</span></span><br><span class="line">        <span class="comment">//4. file print detail 不能查看2kb之外大文件，无法解析出contents内容</span></span><br><span class="line">        <span class="comment">//5. 登录接口只调用一次，使用redis缓存账号密码</span></span><br><span class="line">        <span class="comment">//6. 统一修改接口返回参数 T data</span></span><br><span class="line">        <span class="comment">//7. 使用vim 或cat 来解析cap或pcap抓包文件</span></span><br><span class="line">        <span class="comment">//ApiConnection con = null;</span></span><br><span class="line">        <span class="comment">// connect to router</span></span><br><span class="line">        <span class="comment">//C:\WBYF_IDEA</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// con = initApiConnection(&quot;admin&quot;, &quot;&quot;);</span></span><br><span class="line">            <span class="comment">// log in to router</span></span><br><span class="line">            <span class="comment">//List&lt;Map&lt;String, String&gt;&gt; resultMapList = con.execute(&quot;/file/print&quot;);</span></span><br><span class="line">            Sftp sftp= JschUtil.createSftp(<span class="string">&quot;192.168.2.2&quot;</span>, <span class="number">22</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="comment">//进入远程目录</span></span><br><span class="line">            sftp.cd(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            log.info(<span class="string">&quot;获取sftp文件当前路径&quot;</span>,sftp.pwd());</span><br><span class="line">            log.info(<span class="string">&quot;显示当前目录下的文件&quot;</span>,sftp.ls(<span class="string">&quot;/&quot;</span>));</span><br><span class="line">            List&lt;String&gt; fileList = sftp.ls(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="comment">//下载远程文件</span></span><br><span class="line">            fileList.stream().filter(s -&gt; s.contains(<span class="string">&quot;.cap&quot;</span>) || s.contains(<span class="string">&quot;.pcap&quot;</span>)).forEach(capFile -&gt; sftp.get(capFile, <span class="string">&quot;C:\\WBYF_IDEA\\&quot;</span>));</span><br><span class="line">            <span class="comment">//上传本地文件</span></span><br><span class="line">            <span class="comment">//sftp.put(&quot;e:/test.jpg&quot;, &quot;/opt/upload&quot;);</span></span><br><span class="line">            <span class="comment">//sftp.get(&quot;0325.cap&quot;, &quot;C:\\WBYF_IDEA\\&quot;);</span></span><br><span class="line">            <span class="comment">//关闭连接</span></span><br><span class="line">           <span class="comment">// List&lt;String&gt; strings = FileUtil.readUtf8Lines(&quot;C:\\WBYF_IDEA\\0325.cap&quot;);</span></span><br><span class="line"></span><br><span class="line">            sftp.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResult</span>(<span class="string">&quot;下载pcap数据文件成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;下载pcap抓包文件失败 = &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiResult</span>(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult <span class="title function_">parseLocalPcapFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//String localPwd = System.getProperty(&quot;user.dir&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span><span class="string">&quot;C:\\WBYF_IDEA\\JavaTutorials\\mongodb\\src\\main\\resources\\pcap&quot;</span>;</span><br><span class="line">        List&lt;String&gt; fileList = FileUtil.listFileNames(path);</span><br><span class="line">        List&lt;String&gt; parsedStringList = Lists.newArrayListWithCapacity(fileList.size());</span><br><span class="line">        <span class="keyword">for</span> (String pcapFileName : fileList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pcapFileName.contains(<span class="string">&quot;.cap&quot;</span>)||pcapFileName.contains(<span class="string">&quot;.pcap&quot;</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;pcapFileName = &quot;</span> + path+File.separator+pcapFileName);</span><br><span class="line">                <span class="type">String</span> <span class="variable">parsedString</span> <span class="operator">=</span> FileUtil.readString(path+File.separator+pcapFileName, CharsetUtil.UTF_8);</span><br><span class="line">                parsedStringList.add(parsedString);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//System.out.println(&quot;path = &quot; + path);</span></span><br><span class="line">        <span class="comment">//已经获取到解析好的pcap二进制流数据转String了，接下来分批去重提取账号密码</span></span><br><span class="line">        <span class="comment">//1， winbox公用api端口会被挤下线</span></span><br><span class="line">        <span class="comment">//2. mac地址修改成和服务器一样的</span></span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">ApiResult</span>(parsedStringList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><ul>
<li>使用wireshark 打开抓到的cap 报文即可.<br><img src="https://i.loli.net/2019/05/02/5ccaa3bdac0fa.png" alt="2019-05-02_153339_006.png"></li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.ich8.com/post/3699">抓包获取PPPOE账号密码</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/vivianliulu/article/details/77449780">pppoe源码分析</a></li>
<li><a target="_blank" rel="noopener" href="https://crackzsoft.com/mikrotik-routeros/">mikrotik routeros 6.44.2 LEVEL 6 FOR VMWARE + CRACK</a></li>
<li><a target="_blank" rel="noopener" href="http://demo2.mt.lv/webfig/">mikrotik demo</a> MikroTik RouterOS online demo</li>
<li><a target="_blank" rel="noopener" href="https://wiki.edcwifi.com/index.php?title=MikroTik%E6%89%8B%E5%86%8C">MikroTik手册</a></li>
<li><a target="_blank" rel="noopener" href="https://download.edcwifi.com/index.php?title=MikroTik%E6%89%8B%E5%86%8C">EDCwifi.com</a></li>
<li><a target="_blank" rel="noopener" href="http://www.rosjb.com">pppoe自动到期通知</a></li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/jkwindy/pic4blog2/blob/master/RouterOS_RECOVER_PPPOE_PASSWORD/routeros%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9Av637e.pdf">routeros入门到精通v637e.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.mikrotik.com/wiki/Manual:Tools/Packet_Sniffer">Packet_Sniffer</a> </li>
<li><a target="_blank" rel="noopener" href="https://wiki.mikrotik.com/wiki/Manual:Interface/PPPoE">PPPOE Protocal diagram</a></li>
<li><a target="_blank" rel="noopener" href="https://space.bilibili.com/434853043spm_id_from=333.788.b_765f7570696e666f.2">ros大玩家</a> 视频教程 <code>QQ：1247004718（微信同号）</code></li>
<li><a target="_blank" rel="noopener" href="https://www.edcwifi.com.cn/wiki/13.pdf">RouterOS  edcwifi</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/pdf/rfc2516.pdf">rfc2516.pdf</a> <code>datatracker.ietf.org/doc/rfc2516</code></li>
<li><a target="_blank" rel="noopener" href="https://github.com/GideonLeGrange/mikrotik-java">GideonLeGrange-mikrotik-java</a>  Mikrotik Java API Client</li>
<li><a target="_blank" rel="noopener" href="https://stefenson.github.io/tags/PPPoE/">PPPoE服务器编写</a></li>
<li><a href="[http://www.roslm.com:82/index.php?dir=/002.%E8%B7%AF%E7%94%B1%E4%B8%93%E5%8C%BA](http://www.roslm.com:82/index.php?dir=/002.路由专区)">https://www.ros9.com/index.php</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.google.com/file/d/0ByWLVUEElhsmLXhBeEt3MHk1U2s/edit">HunterTik2.3.1.iso</a></li>
<li><a target="_blank" rel="noopener" href="https://www.huakings.cn/post/216.html">X86 3865U安装ROS+LEDE双软路由(重要插件)</a></li>
<li><a target="_blank" rel="noopener" href="https://stubarea51.net/2020/02/15/mikrotik-routerosv7-first-look-vxlan/">mikrotik-routerosv7-first-look-vxlan</a></li>
<li><a target="_blank" rel="noopener" href="https://help.mikrotik.com/docs/display/ROS/RouterOS">Mikrotik jira docs</a></li>
<li><a target="_blank" rel="noopener" href="https://mirrors.dtops.cc/iso/ros5.25_1G/">MikroTik 5.25</a></li>
<li><a target="_blank" rel="noopener" href="https://www.edcwifi.com.cn/project/afc_api/Public/Uploads/2019-10-17/5da816a82f565.pdf">RouterOS wifi</a></li>
<li><a target="_blank" rel="noopener" href="https://mikrotik.com/download/archive">mikrotik archive</a></li>
<li><a target="_blank" rel="noopener" href="https://kkslinuxinfo.wordpress.com/category/mikrotik-routeros/">RouterOS kernel 2.6.35-3.3.5</a></li>
<li><a target="_blank" rel="noopener" href="https://rickfreyconsulting.com/packet-sniffer/">国外教程网站 https://rickfreyconsulting.com/packet-sniffer/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sky-star/p/pppoe.html">PPPOE拨号上网流程及密码窃取具体实现</a></li>
</ul>

    
  </div>

</article>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持codewindy</div>
        <ul>
        
          <li class="item">
            
              <span>微信扫一扫</span>
            
            <img src="/images/wx.png" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2017/11/21/Oracle-JDK-Download/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2018/09/03/MASTER-OF-SEARCH/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    

<!-- Gitalk评论插件通用代码 -->
<div id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<script>
const gitalk = new Gitalk({
  clientID: '4a826e7e0c60ad01dacc',
  clientSecret: '511911362023e9b195a12b5fdd71ae032922257a',
  repo: 'gittalk4blog',
  owner: 'codewindy',
  // 在这里设置一下截取前50个字符串, 这是因为 github 对 label 的长度有了要求, 如果超过
  // 50个字符串则会报错.
  // id: location.pathname.split('/').pop().substring(0, 49),
  id: md5(location.pathname),
  admin: ['codewindy'],
  // facebook-like distraction free mode
  distractionFreeMode: false
})
gitalk.render('gitalk-container')
</script>
<!-- Gitalk代码结束 -->



  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
